#include <util/delay.h>
#include <avr/io.h>
#include "i2c.h" 
#include "oled.h"


void OLED_command(uint8_t cmd) {
    i2c_start();
    i2c_write(OLED_ADDR << 1); // Dirección con bit de escritura (0)
    i2c_write(0x00);           // Byte de control: Modo Comando (0x00)
    i2c_write(cmd);            // El comando
    i2c_stop();
}

void OLED_data(uint8_t data) {
    i2c_start();
    i2c_write(OLED_ADDR << 1); // Dirección con bit de escritura (0)
    i2c_write(0x40);           // Byte de control: Modo Datos (0x40)
    i2c_write(data);           // El byte de datos
    i2c_stop();
}

void OLED_init(void) {
    _delay_ms(100);
    OLED_command(0xAE); // Display OFF

    OLED_command(0xD5); OLED_command(0x80); // Set Display Clock Divisor / Osc Frequency
    OLED_command(0xA8); OLED_command(0x3F); // Set Multiplex Ratio (63)
    OLED_command(0xD3); OLED_command(0x00); // Set Display Offset
    OLED_command(0x40);                     // Set Start Line Address (0)

    OLED_command(0x8D); OLED_command(0x14); // Charge Pump Setting (Enable)
    OLED_command(0x20); OLED_command(0x00); // Set Memory Addressing Mode (Horizontal Addressing Mode)

    OLED_command(0xA1); // Segment Remap (Column 127 is mapped to SEG0)
    OLED_command(0xC8); // Com Output Scan Direction (remapped mode, scan from COM[N-1] to COM0)

    OLED_command(0xDA); OLED_command(0x12); // Set COM Pins Hardware Configuration
    OLED_command(0x81); OLED_command(0xCF); // Set Contrast Control (Max)
    OLED_command(0xD9); OLED_command(0xF1); // Set Pre-charge Period
    OLED_command(0xDB); OLED_command(0x40); // Set VCOMH Deselect Level

    OLED_command(0xA4); // Nntire Display ON / Resume to RAM content display
    OLED_command(0xA6); // Normal Display (Non-inverted)
    OLED_command(0xAF); // Display ON
}

void OLED_clear(void) {
    for (uint8_t page = 0; page < 8; page++) {
        OLED_command(0xB0 + page); // Establece la página
        OLED_command(0x00);        // Columna inferior (0-15)
        OLED_command(0x10);        // Columna superior (0-7)
        for (uint8_t col = 0; col < 128; col++) {
            OLED_data(0x00); 
        }
    }
}

// Fuente 5x7 COMPLETA (ASCII 32-126)
// Esta fuente contiene todos los 95 caracteres ASCII imprimibles
const uint8_t font5x7[][5] = {
  {0x00,0x00,0x00,0x00,0x00}, // 0x20 (32) space
  {0x00,0x00,0x5F,0x00,0x00}, // 0x21 (33) !
  {0x00,0x07,0x00,0x07,0x00}, // 0x22 (34) "
  {0x14,0x7F,0x14,0x7F,0x14}, // 0x23 (35) #
  {0x24,0x2A,0x7F,0x2A,0x12}, // 0x24 (36) $
  {0x23,0x13,0x08,0x64,0x62}, // 0x25 (37) %
  {0x36,0x49,0x55,0x22,0x50}, // 0x26 (38) &
  {0x00,0x05,0x03,0x00,0x00}, // 0x27 (39) '
  {0x00,0x1C,0x22,0x41,0x00}, // 0x28 (40) (
  {0x00,0x41,0x22,0x1C,0x00}, // 0x29 (41) )
  {0x14,0x08,0x3E,0x08,0x14}, // 0x2A (42) *
  {0x08,0x08,0x3E,0x08,0x08}, // 0x2B (43) +
  {0x00,0x50,0x30,0x00,0x00}, // 0x2C (44) ,
  {0x08,0x08,0x08,0x08,0x08}, // 0x2D (45) -
  {0x00,0x60,0x60,0x00,0x00}, // 0x2E (46) .
  {0x20,0x10,0x08,0x04,0x02}, // 0x2F (47) /
  {0x3E,0x51,0x49,0x45,0x3E}, // 0x30 (48) 0
  {0x00,0x42,0x7F,0x40,0x00}, // 0x31 (49) 1
  {0x42,0x61,0x51,0x49,0x46}, // 0x32 (50) 2
  {0x21,0x41,0x45,0x4B,0x31}, // 0x33 (51) 3
  {0x18,0x14,0x12,0x7F,0x10}, // 0x34 (52) 4
  {0x27,0x45,0x45,0x45,0x39}, // 0x35 (53) 5
  {0x3C,0x4A,0x49,0x49,0x30}, // 0x36 (54) 6
  {0x01,0x71,0x09,0x05,0x03}, // 0x37 (55) 7
  {0x36,0x49,0x49,0x49,0x36}, // 0x38 (56) 8
  {0x06,0x49,0x49,0x29,0x1E}, // 0x39 (57) 9
  {0x00,0x36,0x36,0x00,0x00}, // 0x3A (58) :
  {0x00,0x56,0x36,0x00,0x00}, // 0x3B (59) ;
  {0x08,0x14,0x22,0x41,0x00}, // 0x3C (60) <
  {0x14,0x14,0x14,0x14,0x14}, // 0x3D (61) =
  {0x00,0x41,0x22,0x14,0x08}, // 0x3E (62) >
  {0x02,0x01,0x51,0x09,0x06}, // 0x3F (63) ?
  {0x32,0x49,0x79,0x41,0x3E}, // 0x40 (64) @
  {0x7E,0x11,0x11,0x11,0x7E}, // 0x41 (65) A
  {0x7F,0x49,0x49,0x49,0x36}, // 0x42 (66) B
  {0x3E,0x41,0x41,0x41,0x22}, // 0x43 (67) C
  {0x7F,0x41,0x41,0x22,0x1C}, // 0x44 (68) D
  {0x7F,0x49,0x49,0x49,0x41}, // 0x45 (69) E
  {0x7F,0x09,0x09,0x09,0x01}, // 0x46 (70) F
  {0x3E,0x41,0x49,0x49,0x7A}, // 0x47 (71) G
  {0x7F,0x08,0x08,0x08,0x7F}, // 0x48 (72) H
  {0x00,0x41,0x7F,0x41,0x00}, // 0x49 (73) I
  {0x20,0x40,0x41,0x3F,0x01}, // 0x4A (74) J
  {0x7F,0x08,0x14,0x22,0x41}, // 0x4B (75) K
  {0x7F,0x40,0x40,0x40,0x40}, // 0x4C (76) L
  {0x7F,0x02,0x0C,0x02,0x7F}, // 0x4D (77) M
  {0x7F,0x04,0x08,0x10,0x7F}, // 0x4E (78) N
  {0x3E,0x41,0x41,0x41,0x3E}, // 0x4F (79) O
  {0x7F,0x09,0x09,0x09,0x06}, // 0x50 (80) P
  {0x3E,0x41,0x51,0x21,0x5E}, // 0x51 (81) Q
  {0x7F,0x09,0x19,0x29,0x46}, // 0x52 (82) R
  {0x46,0x49,0x49,0x49,0x31}, // 0x53 (83) S
  {0x01,0x01,0x7F,0x01,0x01}, // 0x54 (84) T
  {0x3F,0x40,0x40,0x40,0x3F}, // 0x55 (85) U
  {0x1F,0x20,0x40,0x20,0x1F}, // 0x56 (86) V
  {0x3F,0x40,0x38,0x40,0x3F}, // 0x57 (87) W
  {0x63,0x14,0x08,0x14,0x63}, // 0x58 (88) X
  {0x07,0x08,0x70,0x08,0x07}, // 0x59 (89) Y
  {0x61,0x51,0x49,0x45,0x43}, // 0x5A (90) Z
  {0x00,0x7F,0x41,0x41,0x00}, // 0x5B (91) [
  {0x02,0x04,0x08,0x10,0x20}, // 0x5C (92) "\"
  {0x00,0x41,0x41,0x7F,0x00}, // 0x5D (93) ]
  {0x04,0x02,0x01,0x02,0x04}, // 0x5E (94) ^
  {0x40,0x40,0x40,0x40,0x40}, // 0x5F (95) _
  {0x00,0x01,0x02,0x04,0x00}, // 0x60 (96) `
  {0x20,0x54,0x54,0x54,0x78}, // 0x61 (97) a
  {0x7F,0x48,0x44,0x44,0x38}, // 0x62 (98) b
  {0x38,0x44,0x44,0x44,0x20}, // 0x63 (99) c
  {0x38,0x44,0x44,0x48,0x7F}, // 0x64 (100) d
  {0x38,0x54,0x54,0x54,0x18}, // 0x65 (101) e
  {0x08,0x7F,0x09,0x01,0x02}, // 0x66 (102) f
  {0x0C,0x52,0x52,0x52,0x3E}, // 0x67 (103) g
  {0x7F,0x08,0x04,0x04,0x78}, // 0x68 (104) h
  {0x00,0x44,0x7D,0x40,0x00}, // 0x69 (105) i
  {0x20,0x40,0x44,0x3D,0x00}, // 0x6A (106) j
  {0x7F,0x10,0x28,0x44,0x00}, // 0x6B (107) k
  {0x00,0x7F,0x40,0x40,0x00}, // 0x6C (108) l
  {0x7C,0x04,0x18,0x04,0x78}, // 0x6D (109) m
  {0x7C,0x08,0x04,0x04,0x78}, // 0x6E (110) n
  {0x38,0x44,0x44,0x44,0x38}, // 0x6F (111) o
  {0x7C,0x14,0x14,0x14,0x08}, // 0x70 (112) p
  {0x08,0x14,0x14,0x18,0x7C}, // 0x71 (113) q
  {0x7C,0x08,0x04,0x04,0x08}, // 0x72 (114) r
  {0x48,0x54,0x54,0x54,0x20}, // 0x73 (115) s
  {0x04,0x3F,0x44,0x40,0x20}, // 0x74 (116) t
  {0x3C,0x40,0x40,0x20,0x7C}, // 0x75 (117) u
  {0x1C,0x20,0x40,0x20,0x1C}, // 0x76 (118) v
  {0x3C,0x40,0x30,0x40,0x3C}, // 0x77 (119) w
  {0x44,0x28,0x10,0x28,0x44}, // 0x78 (120) x
  {0x0C,0x50,0x50,0x50,0x3C}, // 0x79 (121) y
  {0x44,0x64,0x54,0x4C,0x44}, // 0x7A (122) z
  {0x00,0x08,0x36,0x41,0x00}, // 0x7B (123) {
  {0x00,0x00,0x7F,0x00,0x00}, // 0x7C (124) |
  {0x00,0x41,0x36,0x08,0x00}, // 0x7D (125) }
  {0x02,0x01,0x02,0x04,0x02}, // 0x7E (126) ~
};

///////////////////////////////////////

void OLED_set_cursor(uint8_t page, uint8_t column) {
    OLED_command(0xB0 + page);
    OLED_command(0x00 + (column & 0x0F));
    OLED_command(0x10 + ((column >> 4) & 0x0F)); 
}

void OLED_char(char c) {
    // Si un caracter no está en el rango ASCII 32-126, se mostrará '?'.
    if (c < 32 || c > 126) c = '?';
    
    const uint8_t *bitmap = font5x7[c - 32]; // Resta 32 para el desplazamiento ASCII
    for (uint8_t i = 0; i < 5; i++) {
        OLED_data(bitmap[i]); // Escribe cada columna del caracter
    }
    OLED_data(0x00); // Un pixel de espacio entre caracteres
}

void OLED_print(uint8_t page, uint8_t column, const char *str) {
    OLED_set_cursor(page, column);
    while (*str) {
        OLED_char(*str++);
    }
}



